name: Update YouTube OAuth Refresh Token

on:
  # æ‰‹å‹•ãƒˆãƒªã‚¬ãƒ¼ç”¨ã€‚auth_code ã‚’å–å¾—ã—ãŸå¾Œã€æ‰‹å‹•ã§å®Ÿè¡Œã™ã‚‹
  # @see https://github.com/Ayato-kosaka/live-streaming/issues/13#issuecomment-2795265041
  workflow_dispatch:
    inputs:
      auth_code:
        description: 'Google OAuth èªè¨¼å¾Œã«å¾—ã‚‰ã‚ŒãŸ "code" ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿'
        required: true

jobs:
  exchange-code-and-update-secret:
    name: Exchange Auth Code & Update Secret
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ Google OAuth ãƒˆãƒ¼ã‚¯ãƒ³ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¸ POST ã—ã¦ã€refresh_token ã‚’å–å¾—
      - name: Exchange auth_code for refresh_token
        id: fetch_token
        run: |
          echo "ğŸ” å–å¾—ä¸­: Google OAuth ãƒˆãƒ¼ã‚¯ãƒ³..."

          # Google OAuth ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
          RESPONSE=$(curl -s -X POST https://oauth2.googleapis.com/token \
            -d client_id="${{ secrets.YOUTUBE_CLIENT_ID }}" \
            -d client_secret="${{ secrets.YOUTUBE_CLIENT_SECRET }}" \
            -d code="${{ github.event.inputs.auth_code }}" \
            -d grant_type=authorization_code \
            -d redirect_uri="https://oauth2.example.com/callback")

          echo "ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’å—ä¿¡ âœ…"

          # refresh_token ã‚’æŠ½å‡ºï¼ˆjq ã§ JSON ãƒ‘ãƒ¼ã‚¹ï¼‰
          REFRESH_TOKEN=$(echo "$RESPONSE" | jq -r '.refresh_token')

          # ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ï¼šrefresh_token ãŒå–ã‚Œãªã‹ã£ãŸå ´åˆ
          if [[ -z "$REFRESH_TOKEN" || "$REFRESH_TOKEN" == "null" ]]; then
            echo "âŒ refresh_token ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚auth_code ã¾ãŸã¯èªè¨¼æƒ…å ±ã‚’å†ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
            echo "ãƒ¬ã‚¹ãƒãƒ³ã‚¹å†…å®¹: $RESPONSE"
            exit 1
          fi

          # æ©Ÿå¯†æƒ…å ±ã®ãƒã‚¹ã‚¯å‡ºåŠ›ï¼ˆGitHub Actionsãƒ­ã‚°ä¸Šã«å‡ºã•ãªã„ï¼‰
          echo "::add-mask::$REFRESH_TOKEN"

          # æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã§ä½¿ãˆã‚‹ã‚ˆã†ã«å‡ºåŠ›
          echo "refresh_token=$REFRESH_TOKEN" >> $GITHUB_OUTPUT

      # 2ï¸âƒ£ GitHub API ã‚’ä½¿ã£ã¦ã€GitHub ã®å…¬é–‹éµï¼ˆkey_idï¼‰ã‚’å–å¾—
      - name: Get GitHub Public Key
        id: get_key
        run: |
          echo "å…¬é–‹éµã®å–å¾—ä¸­..."
          KEY_RESPONSE=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            https://api.github.com/repos/${{ github.repository }}/actions/secrets/public-key)

          # å…¬é–‹éµã¨ key_id ã‚’å–å¾—
          GITHUB_KEY_ID=$(echo "$KEY_RESPONSE" | jq -r '.key_id')
          GITHUB_KEY=$(echo "$KEY_RESPONSE" | jq -r '.key')

          echo "å…¬é–‹éµå–å¾— âœ…"
          echo "GITHUB_KEY_ID=$GITHUB_KEY_ID" >> $GITHUB_ENV
          echo "GITHUB_KEY=$GITHUB_KEY" >> $GITHUB_ENV

      # 3ï¸âƒ£ refresh_token ã‚’æš—å·åŒ–ã—ã¦ GitHub Secrets ã«æ›´æ–°
      - name: Encrypt and Update GitHub Secret (YOUTUBE_REFRESH_TOKEN)
        run: |
          # refresh_token ã‚’æš—å·åŒ–
          ENCRYPTED_TOKEN=$(echo -n "${{ steps.fetch_token.outputs.refresh_token }}" | \
            openssl rsautl -encrypt -inkey <(echo "${{ env.GITHUB_KEY }}") -pubin | base64)

          # GitHub Secrets API ã‚’å‘¼ã³å‡ºã—ã¦æ›´æ–°
          curl -X PUT https://api.github.com/repos/${{ github.repository }}/actions/secrets/YOUTUBE_REFRESH_TOKEN \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d "{\"encrypted_value\":\"$ENCRYPTED_TOKEN\", \"key_id\":\"${{ env.GITHUB_KEY_ID }}\"}"

      # 4ï¸âƒ£ æ›´æ–°å¾Œã€firebase-functions-deploy.yml ã‚’ã‚­ãƒƒã‚¯ã—ã¦ãƒ‡ãƒ—ãƒ­ã‚¤å®Ÿè¡Œ
      - name: Trigger Firebase Functions Deploy Workflow
        uses: benc-uk/workflow-dispatch@v1
        with:
          workflow: firebase-functions-deploy.yml
          token: ${{ secrets.GITHUB_PAT }}

