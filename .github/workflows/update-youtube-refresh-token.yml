name: Update YouTube OAuth Refresh Token

on:
  # æ‰‹å‹•ãƒˆãƒªã‚¬ãƒ¼ç”¨ã€‚auth_code ã‚’å–å¾—ã—ãŸå¾Œã€æ‰‹å‹•ã§å®Ÿè¡Œã™ã‚‹
  # @see https://github.com/Ayato-kosaka/live-streaming/issues/13#issuecomment-2795265041
  workflow_dispatch:
    inputs:
      auth_code:
        description: 'Google OAuth èªè¨¼å¾Œã«å¾—ã‚‰ã‚ŒãŸ "code" ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿'
        required: true

jobs:
  exchange-code-and-update-secret:
    name: Exchange Auth Code & Update Secret
    runs-on: ubuntu-latest

    steps:
      # ğŸ›  å¿…è¦ãªãƒ„ãƒ¼ãƒ«ãƒ»ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      - name: Setup node modules
        run: |
          sudo apt-get update
          sudo apt-get install -y jq
          npm install tweetnacl js-base64
          
      # ğŸ” Step 1: èªè¨¼ã‚³ãƒ¼ãƒ‰ã‹ã‚‰ refresh_token ã‚’å–å¾—ï¼ˆGoogle OAuthï¼‰
      - name: Exchange auth_code for refresh_token
        id: fetch_token
        run: |
          echo "ğŸ” å–å¾—ä¸­: Google OAuth ãƒˆãƒ¼ã‚¯ãƒ³..."

          # Google OAuth ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
          RESPONSE=$(curl -s -X POST https://oauth2.googleapis.com/token \
            -d client_id="${{ secrets.YOUTUBE_CLIENT_ID }}" \
            -d client_secret="${{ secrets.YOUTUBE_CLIENT_SECRET }}" \
            -d code="${{ github.event.inputs.auth_code }}" \
            -d grant_type=authorization_code \
            -d redirect_uri="https://oauth2.example.com/callback")

          echo "ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’å—ä¿¡ âœ…"

          # refresh_token ã‚’æŠ½å‡ºï¼ˆjq ã§ JSON ãƒ‘ãƒ¼ã‚¹ï¼‰
          REFRESH_TOKEN=$(echo "$RESPONSE" | jq -r '.refresh_token')

          # ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ï¼šrefresh_token ãŒå–ã‚Œãªã‹ã£ãŸå ´åˆ
          if [[ -z "$REFRESH_TOKEN" || "$REFRESH_TOKEN" == "null" ]]; then
            echo "âŒ refresh_token ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚auth_code ã¾ãŸã¯èªè¨¼æƒ…å ±ã‚’å†ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
            echo "ãƒ¬ã‚¹ãƒãƒ³ã‚¹å†…å®¹: $RESPONSE"
            exit 1
          fi

          # æ©Ÿå¯†æƒ…å ±ã®ãƒã‚¹ã‚¯å‡ºåŠ›ï¼ˆGitHub Actionsãƒ­ã‚°ä¸Šã«å‡ºã•ãªã„ï¼‰
          echo "::add-mask::$REFRESH_TOKEN"

          # æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã§ä½¿ãˆã‚‹ã‚ˆã†ã«å‡ºåŠ›
          echo "refresh_token=$REFRESH_TOKEN" >> $GITHUB_OUTPUT

      # ğŸ”‘ Step 2: å…¬é–‹éµï¼ˆkey_id, keyï¼‰ã‚’å–å¾—ã—ã€ç’°å¢ƒå¤‰æ•°ã«ä¿å­˜
      - name: Get GitHub Public Key
        id: get_key
        run: |
          echo "ğŸ”‘ GitHub å…¬é–‹éµã®å–å¾—ä¸­..."
          PUBKEY_JSON=$(curl -s -H "Authorization: token ${{ secrets.GH_ADMIN_PAT }}" \
            https://api.github.com/repos/${{ github.repository }}/actions/secrets/public-key)

          KEY_ID=$(echo "$PUBKEY_JSON" | jq -r '.key_id')
          PUBLIC_KEY=$(echo "$PUBKEY_JSON" | jq -r '.key')

          echo "KEY_ID=$KEY_ID" >> $GITHUB_ENV
          echo "PUBLIC_KEY=$PUBLIC_KEY" >> $GITHUB_ENV

      # ğŸ”’ Step 3: refresh_token ã‚’ NaCl ã§æš—å·åŒ–ï¼ˆNode.jsï¼‰
      - name: Encrypt refresh_token using libsodium
        id: encrypt
        run: |
          echo "
          const nacl = require('tweetnacl');
          const b64 = require('js-base64');

          const key_b64 = process.env.PUBLIC_KEY;
          const message = process.env.REFRESH_TOKEN;

          const key = b64.toByteArray(key_b64);
          const msg = Buffer.from(message);

          const sealedbox = nacl.box.seal(msg, key);
          const encrypted = b64.fromUint8Array(sealedbox);

          console.log('::set-output name=encrypted::' + encrypted);
          " > encrypt.js

          node encrypt.js

      # ğŸ“ Step 4: GitHub Secrets ã«ä¿å­˜
      - name: Update GitHub Secret (YOUTUBE_REFRESH_TOKEN)
        run: |
          curl -X PUT https://api.github.com/repos/${{ github.repository }}/actions/secrets/YOUTUBE_REFRESH_TOKEN \
            -H "Authorization: token ${{ secrets.GH_PAT }}" \
            -H "Content-Type: application/json" \
            -d "{
              \"encrypted_value\": \"${{ steps.encrypt.outputs.encrypted }}\",
              \"key_id\": \"${{ env.KEY_ID }}\"
            }"

      # ğŸš€ Step 5: firebase-functions-deploy ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’ãƒˆãƒªã‚¬ãƒ¼
      - name: Trigger Firebase Functions Deploy Workflow
        uses: benc-uk/workflow-dispatch@v1
        with:
          workflow: firebase-functions-deploy.yml
          token: ${{ secrets.GH_PAT }}

