<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>æ–™ç†ç”»åƒ æœ€é©åŒ–çŠ¶æ³ãƒ‰ãƒ¼ãƒŠãƒ„</title>
    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        width: 100vw;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        padding: 24px 0;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        background: #ffffff;
        color: #111827;
      }

      .donut-wrapper {
        position: relative;
        width: min(90vw, 480px);
        height: min(90vw, 480px);
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .donut-svg {
        width: 100%;
        height: 100%;
        transform: rotate(-90deg);
      }

      .donut-bg {
        fill: none;
        stroke: #e5e7eb;
        stroke-width: 16;
      }

      .donut-progress {
        fill: none;
        stroke: #22c55e;
        stroke-width: 16;
        stroke-linecap: round;
        transition: stroke 0.2s ease-out;
      }

      .center-text {
        position: absolute;
        text-align: center;
        pointer-events: none;
      }

      .center-text-main {
        font-size: clamp(24px, 4vw, 40px);
        font-weight: 600;
      }

      .center-text-value {
        font-size: clamp(28px, 10vw, 46px);
        font-weight: 700;
        margin: 6px 0;
        color: #22c55e;
      }

      .center-text-sub {
        font-size: clamp(18px, 4vw, 28px);
        color: #374151;
        line-height: 1.4;
      }

      .center-text-status {
        font-size: clamp(14px, 3vw, 18px);
        color: #6b7280;
        margin-top: 8px;
      }

      .center-text-error {
        color: #ef4444;
      }

      .category-grid {
        width: min(90vw, 480px);
        margin: 24px auto 0;
        display: grid;
        grid-template-columns: repeat(3, minmax(0, 1fr));
        gap: 12px;
      }

      .category-card {
        position: relative;
        border-radius: 16px;
        overflow: hidden;
        background: #f3f4f6;
        width: 100%;
      }

      /* æ­£æ–¹å½¢ã‚’ä½œã‚‹ãŸã‚ã®ãƒ€ãƒŸãƒ¼è¦ç´ ï¼ˆé«˜ã•ç¢ºä¿ç”¨ï¼‰ */
      .category-card::before {
        content: "";
        display: block;
        padding-top: 100%; /* é«˜ã• = å¹… â†’ 1:1 ã®æ­£æ–¹å½¢ */
      }

      .category-card img {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
        display: block;
        object-fit: cover;
      }

      /* ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã¯ä¸‹ã«ã‹ã¶ã›ã‚‹ */
      .category-card-overlay {
        position: absolute;
        left: 0;
        right: 0;
        bottom: 0;
        padding: 6px 8px;
        font-size: 12px;
        color: #ffffff;
        background: linear-gradient(
          to top,
          rgba(0, 0, 0, 0.6),
          rgba(0, 0, 0, 0)
        );
      }

      .category-card-name {
        font-weight: 600;
      }

      .category-card-placeholder {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #e5e7eb;
        color: #9ca3af;
        font-size: 24px;
      }
    </style>
  </head>
  <body>
    <div class="donut-wrapper">
      <svg class="donut-svg" viewBox="0 0 200 200">
        <circle class="donut-bg" cx="100" cy="100" r="80"></circle>
        <circle class="donut-progress" cx="100" cy="100" r="80"></circle>
      </svg>

      <div class="center-text">
        <div class="center-text-main">æœ€é©åŒ–æ¸ˆ</div>
        <div class="center-text-value" id="optimizedCount">0</div>
        <div class="center-text-sub">
          æ–™ç†ç”»åƒ: <span id="totalCount">0</span><br />
          å®Œäº†ç‡: <span id="percentLabel">0</span>%
        </div>
        <div class="center-text-status" id="statusText">èª­ã¿è¾¼ã¿ä¸­â€¦</div>
      </div>
    </div>

    <div id="categoryGrid" class="category-grid"></div>

    <script>
      const API_ENDPOINT =
        "https://script.google.com/macros/s/AKfycbxvafi5bnC1wi9dFitu4IZVYFMsZ9fF06rYt06QwksD85SbhbdKbaQya5Q2Ii6pCnyO/exec";

      const optimizedEl = document.getElementById("optimizedCount");
      const totalEl = document.getElementById("totalCount");
      const percentLabelEl = document.getElementById("percentLabel");
      const statusTextEl = document.getElementById("statusText");
      const progressCircle = document.querySelector(".donut-progress");
      const gridEl = document.getElementById("categoryGrid");

      const radius = 80;
      const circumference = 2 * Math.PI * radius;

      progressCircle.style.strokeDasharray = `${circumference}`;
      progressCircle.style.strokeDashoffset = `${circumference}`;

      function animate(optimized, total) {
        const percent = total > 0 ? Math.round((optimized / total) * 100) : 0;
        totalEl.textContent = total;

        const animationDuration = 1000;
        let startTime = null;

        function step(timestamp) {
          if (!startTime) startTime = timestamp;
          const elapsed = timestamp - startTime;
          const t = Math.min(elapsed / animationDuration, 1);
          const ease = 1 - (1 - t) * (1 - t);

          const currentOptimized = Math.floor(optimized * ease);
          const currentPercent = Math.floor(percent * ease);

          optimizedEl.textContent = currentOptimized;
          percentLabelEl.textContent = currentPercent;

          const offset = circumference * (1 - currentPercent / 100);
          progressCircle.style.strokeDashoffset = offset;

          if (t < 1) requestAnimationFrame(step);
        }

        requestAnimationFrame(step);
      }

      function renderCategories(categories) {
        if (!gridEl) return;
        gridEl.innerHTML = "";

        categories.forEach((cat) => {
          const card = document.createElement("div");
          card.className = "category-card";

          const img = document.createElement("img");
          img.src = cat.image_url;
          img.alt = cat.name;
          img.onerror = function () {
            if (this.dataset.errorHandled) return;
            this.dataset.errorHandled = "true";
            this.style.display = "none";
            const placeholder = document.createElement("div");
            placeholder.className = "category-card-placeholder";
            placeholder.textContent = "ğŸ½ï¸";
            card.insertBefore(placeholder, card.firstChild);
          };

          const overlay = document.createElement("div");
          overlay.className = "category-card-overlay";

          const nameDiv = document.createElement("div");
          nameDiv.className = "category-card-name";
          nameDiv.textContent = cat.name;

          overlay.appendChild(nameDiv);
          card.appendChild(img);
          card.appendChild(overlay);
          gridEl.appendChild(card);
        });
      }

      // â˜… JSONP ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆGAS ã‹ã‚‰å‘¼ã°ã‚Œã‚‹ï¼‰
      async function handleApiData(data) {
        try {
          if (data.error) {
            throw new Error(data.message || "Unknown error from API");
          }

          const optimizedConfig = data.config.find(
            (c) => c.key === "optimized"
          );
          const optimized = optimizedConfig
            ? Number(optimizedConfig.value ?? optimizedConfig)
            : 0;

          const totalConfig = data.config.find((c) => c.key === "total");
          const total = totalConfig
            ? Number(totalConfig.value ?? totalConfig)
            : 0;

          // ã“ã“ã§ã€Œç”»åƒèª­ã¿è¾¼ã¿ä¸­â€¦ã€ã«ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
          statusTextEl.textContent = "ç”»åƒèª­ã¿è¾¼ã¿ä¸­â€¦";

          const categories = Array.isArray(data.dishCategories)
            ? data.dishCategories
            : [];

          // å…¨ç”»åƒã®å…ˆèª­ã¿ã‚’å¾…ã¤
          const urls = categories.map((c) => c.image_url).filter(Boolean);
          await preloadImages(urls);

          // ã“ã“ã¾ã§æ¥ãŸã‚‰ã€Œãƒ‡ãƒ¼ã‚¿ + ç”»åƒã€ä¸¡æ–¹æº–å‚™å®Œäº†ï¼
          statusTextEl.style.display = "none";

          // ã¾ãšã‚«ãƒ¼ãƒ‰æç”»
          renderCategories(categories);

          // ãã®ã‚ã¨ãƒ‰ãƒ¼ãƒŠãƒ„ã®æ•°å­—ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹
          animate(optimized, total);
        } catch (error) {
          console.error("API data error:", error);
          statusTextEl.textContent = "å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ";
          statusTextEl.classList.add("center-text-error");
          animate(0, 0);
        }
      }

      // ç”»åƒã‚’å…¨éƒ¨èª­ã¿çµ‚ã‚ã‚‹ã¾ã§å¾…ã¤ Promise
      function preloadImages(urls, timeoutMs = 10000) {
        const uniqueUrls = Array.from(new Set(urls.filter(Boolean)));
        if (uniqueUrls.length === 0) return Promise.resolve([]);

        const promises = uniqueUrls.map((url) => {
          return new Promise((resolve) => {
            const img = new Image();
            let done = false;

            const finish = (ok) => {
              if (done) return;
              done = true;
              resolve({ url, ok });
            };

            img.onload = () => finish(true);
            img.onerror = () => finish(false);

            // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆç”»åƒã‚µãƒ¼ãƒè½ã¡ãŸã¨ããªã©ã«ãƒãƒ³ã‚°ã—ãªã„ã‚ˆã†ã«ï¼‰
            if (timeoutMs) {
              setTimeout(() => finish(false), timeoutMs);
            }

            img.src = url;
          });
        });

        return Promise.all(promises);
      }

      // â˜… JSONP ç”¨ã® <script> ã‚’å‹•çš„ã«è¿½åŠ 
      function fetchDataJsonp() {
        const script = document.createElement("script");
        // callback=handleApiData ã‚’ä»˜ã‘ã‚‹
        script.src = API_ENDPOINT + "?callback=handleApiData";
        script.onerror = function () {
          console.error("JSONP script load error");
          statusTextEl.textContent = "å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ";
          statusTextEl.classList.add("center-text-error");
          animate(0, 0);
        };
        document.body.appendChild(script);
      }

      // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«å®Ÿè¡Œ
      fetchDataJsonp();
    </script>
  </body>
</html>
